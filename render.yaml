services:
  # ============ API (Node + Mongo) ============
  - type: web
    name: ut-api
    env: node
    rootDir: .
    plan: free
    buildCommand: |
      set -e
      mkdir -p api/config api/middleware api/models api/routes
      # package.json
      cat > api/package.json <<'JSON'
      {
        "name": "fc26-api",
        "version": "1.0.0",
        "type": "module",
        "main": "server.js",
        "scripts": { "start": "node server.js" },
        "dependencies": {
          "cors": "^2.8.5",
          "dotenv": "^16.4.5",
          "express": "^4.19.2",
          "helmet": "^7.1.0",
          "mongoose": "^8.6.2",
          "morgan": "^1.10.0"
        }
      }
      JSON
      # server.js
      cat > api/server.js <<'JS'
      import 'dotenv/config';
      import express from 'express';
      import helmet from 'helmet';
      import morgan from 'morgan';
      import cors from 'cors';
      import { connectDB } from './config/db.js';
      import { apiKey } from './middleware/auth.js';
      import accountsRoute from './routes/accounts.js';
      import playersRoute from './routes/players.js';
      import statsRoute from './routes/stats.js';
      const app = express();
      // CORS allowlist
      const allowed = (process.env.ALLOWED_ORIGINS || '').split(',').map(s=>s.trim()).filter(Boolean);
      app.use(cors({
        origin: (origin, cb) => {
          if (!origin || allowed.includes(origin) || /\.onrender\.com$/.test(origin)) return cb(null, true);
          return cb(new Error('Not allowed by CORS'));
        }
      }));
      app.use(helmet());
      app.use(express.json({ limit: '2mb' }));
      app.use(morgan('dev'));
      app.get('/', (_req, res) => res.json({ ok: true, service: 'FC26 API' }));
      app.use('/api', apiKey);
      app.use('/api/accounts', accountsRoute);
      app.use('/api/players', playersRoute);
      app.use('/api/stats', statsRoute);
      const port = process.env.PORT || 3000;
      const uri = process.env.MONGO_URI;
      if (!uri) { console.error('MONGO_URI missing'); process.exit(1); }
      connectDB(uri).then(() => {
        app.listen(port, () => console.log('✅ API on :' + port));
      }).catch(e => { console.error(e); process.exit(1); });
      JS
      # config/db.js
      cat > api/config/db.js <<'JS'
      import mongoose from 'mongoose';
      export async function connectDB(uri) {
        await mongoose.connect(uri, { serverSelectionTimeoutMS: 10000 });
        console.log('✅ MongoDB connected');
      }
      JS
      # middleware/auth.js
      cat > api/middleware/auth.js <<'JS'
      export function apiKey(req, res, next) {
        const k = req.header('x-api-key');
        if (!process.env.API_KEY) return res.status(500).json({ error: 'API key not set' });
        if (!k || k !== process.env.API_KEY) return res.status(401).json({ error: 'Unauthorized' });
        next();
      }
      JS
      # models
      cat > api/models/Account.js <<'JS'
      import mongoose from 'mongoose';
      const AccountSchema = new mongoose.Schema({
        username: { type: String, required: true, index: true },
        platform: { type: String, enum: ['ps','xb','pc'], default: 'pc' },
        region: String,
        coins: { type: Number, default: 0 },
        clubValue: { type: Number, default: 0 },
        lastCheckedAt: Date,
        status: { type: String, enum: ['ok','locked','banned'], default: 'ok' },
        meta: { type: Object }
      }, { timestamps: true });
      export default mongoose.model('Account', AccountSchema);
      JS
      cat > api/models/Player.js <<'JS'
      import mongoose from 'mongoose';
      const PlayerSchema = new mongoose.Schema({
        playerId: { type: Number, required: true, unique: true },
        name: String,
        rating: Number,
        position: String,
        club: String,
        nation: String,
        attributes: Object
      }, { timestamps: true });
      export default mongoose.model('Player', PlayerSchema);
      JS
      cat > api/models/AccountPlayer.js <<'JS'
      import mongoose from 'mongoose';
      const AccountPlayerSchema = new mongoose.Schema({
        accountId: { type: mongoose.Schema.Types.ObjectId, ref: 'Account', index: true, required: true },
        playerId: { type: Number, index: true, required: true },
        name: String,
        rating: Number,
        position: String,
        quality: String,
        quantity: { type: Number, default: 1 },
        sellValue: { type: Number, default: 0 }
      }, { timestamps: true });
      AccountPlayerSchema.index({ accountId: 1, playerId: 1 }, { unique: true });
      export default mongoose.model('AccountPlayer', AccountPlayerSchema);
      JS
      # routes
      cat > api/routes/accounts.js <<'JS'
      import express from 'express';
      import Account from '../models/Account.js';
      import AccountPlayer from '../models/AccountPlayer.js';
      const router = express.Router();
      router.get('/', async (_req, res) => {
        const items = await Account.find().sort({ updatedAt: -1 }).limit(200).lean();
        res.json(items);
      });
      router.post('/', async (req, res) => {
        const { username, coins = 0, platform = 'pc', region, status='ok', meta } = req.body;
        const acc = await Account.findOneAndUpdate(
          { username, platform },
          { $set: { coins, region, status, meta, lastCheckedAt: new Date() } },
          { upsert: true, new: true }
        );
        res.json(acc);
      });
      router.put('/:id/players', async (req, res) => {
        const { players } = req.body;
        if (!Array.isArray(players)) return res.status(400).json({ error: 'players[] required' });
        for (const p of players) {
          await AccountPlayer.findOneAndUpdate(
            { accountId: req.params.id, playerId: p.playerId },
            { $set: p },
            { upsert: true }
          );
        }
        res.json({ ok: true });
      });
      router.get('/:id/players', async (req, res) => {
        const items = await AccountPlayer.find({ accountId: req.params.id }).sort({ rating: -1 }).limit(500).lean();
        res.json(items);
      });
      router.get('/:id/summary', async (req, res) => {
        const acc = await Account.findById(req.params.id).lean();
        if (!acc) return res.status(404).json({ error: 'Account not found' });
        const agg = await AccountPlayer.aggregate([
          { $match: { accountId: acc._id } },
          { $group: { _id: null, totalPlayers: { $sum: '$quantity' }, totalMarketValue: { $sum: { $multiply: ['$sellValue', '$quantity'] } } } }
        ]);
        res.json({
          accountId: acc._id, username: acc.username, platform: acc.platform,
          coins: acc.coins, lastCheckedAt: acc.lastCheckedAt,
          totalPlayers: agg[0]?.totalPlayers || 0, totalMarketValue: agg[0]?.totalMarketValue || 0,
          clubValue: acc.clubValue
        });
      });
      export default router;
      JS
      cat > api/routes/players.js <<'JS'
      import express from 'express';
      import Player from '../models/Player.js';
      const router = express.Router();
      router.post('/', async (req, res) => {
        const { playerId } = req.body;
        if (!playerId) return res.status(400).json({ error: 'playerId required' });
        const doc = await Player.findOneAndUpdate({ playerId }, { $set: req.body }, { upsert: true, new: true });
        res.json(doc);
      });
      router.get('/search', async (req, res) => {
        const q = String(req.query.q || '').trim();
        if (!q) return res.json({ items: [] });
        const rx = new RegExp(q, 'i');
        const items = await Player.find({ name: rx }).limit(50).lean();
        res.json({ items });
      });
      export default router;
      JS
      cat > api/routes/stats.js <<'JS'
      import express from 'express';
      import Account from '../models/Account.js';
      const router = express.Router();
      router.get('/coins', async (_req, res) => {
        const agg = await Account.aggregate([{ $group: { _id: null, totalCoins: { $sum: '$coins' }, accounts: { $sum: 1 } } }]);
        res.json(agg[0] || { totalCoins: 0, accounts: 0 });
      });
      export default router;
      JS
      cd api
      npm install
    startCommand: "node api/server.js"
    envVars:
      - key: MONGO_URI
        value: mongodb+srv://doufi:Ossama00.aA%40@cluster0.7gbw6tf.mongodb.net/fc26?retryWrites=true&w=majority&appName=Cluster0
      - key: API_KEY
        value: ut_gaming_9837xKEY
      - key: PORT
        value: "3000"
      - key: ALLOWED_ORIGINS
        value: https://dashboard.ut-gaming.info

  # ============ Dashboard (React/Vite → Static) ============
  - type: web
    name: ut-web
    env: static
    rootDir: .
    buildCommand: |
      set -e
      mkdir -p web/src
      cat > web/package.json <<'JSON'
      {
        "name": "fc26-dashboard",
        "private": true,
        "version": "1.0.0",
        "type": "module",
        "scripts": { "dev": "vite", "build": "vite build", "preview": "vite preview" },
        "dependencies": { "react": "^18.3.1", "react-dom": "^18.3.1" },
        "devDependencies": { "@vitejs/plugin-react": "^4.3.1", "vite": "^5.4.8" }
      }
      JSON
      cat > web/index.html <<'HTML'
      <!doctype html>
      <html><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width,initial-scale=1.0"/><title>UT Gaming Dashboard</title></head>
      <body><div id="root"></div><script type="module" src="/src/main.jsx"></script></body></html>
      HTML
      cat > web/src/main.jsx <<'JSX'
      import React from 'react'
      import { createRoot } from 'react-dom/client'
      import App from './App.jsx'
      createRoot(document.getElementById('root')).render(<App />)
      JSX
      cat > web/src/App.jsx <<'JSX'
      import React, { useState, useEffect } from 'react';
      function n(x){return (x==null||isNaN(x))?'-':new Intl.NumberFormat().format(x)}
      async function api(path,{base, key, method='GET', body}){
        const res = await fetch(base.replace(/\/$/,'')+path,{method,headers:{'content-type':'application/json','x-api-key':key}, body: body?JSON.stringify(body):undefined});
        if(!res.ok) throw new Error(await res.text()); return res.json();
      }
      export default function App(){
        const [base,setBase]=useState('https://api.ut-gaming.info');
        const [key,setKey]=useState('ut_gaming_9837xKEY');
        const [accounts,setAccounts]=useState([]); const [sel,setSel]=useState(null);
        const [summary,setSummary]=useState(null); const [players,setPlayers]=useState([]);
        async function load(){ const a=await api('/api/accounts',{base, key}); setAccounts(a); if(a[0]) setSel(a[0]); }
        async function loadSel(id){ const s=await api(`/api/${'accounts'}/${id}/summary`,{base,key}); setSummary(s); const p=await api(`/api/accounts/${id}/players`,{base,key}); setPlayers(p); }
        useEffect(()=>{ if(sel?._id){ loadSel(sel._id); } },[sel]);
        return (<div style={{fontFamily:'sans-serif',padding:16,maxWidth:1080,margin:'0 auto'}}>
          <h2>UT Gaming — Dashboard</h2>
          <div style={{display:'flex',gap:8,flexWrap:'wrap',margin:'8px 0'}}>
            <input value={base} onChange={e=>setBase(e.target.value)} placeholder="API Base URL" style={{padding:6,minWidth:360}} />
            <input value={key} onChange={e=>setKey(e.target.value)} placeholder="x-api-key" style={{padding:6,minWidth:240}} />
            <button onClick={load}>Reload</button>
          </div>
          <div style={{display:'grid',gridTemplateColumns:'1fr 2fr',gap:16}}>
            <div>
              <h3>Accounts</h3>
              <ul style={{border:'1px solid #ddd',padding:8,maxHeight:320,overflow:'auto',listStyle:'none'}}>
                {accounts.map(a=>(
                  <li key={a._id} onClick={()=>setSel(a)} style={{padding:6,cursor:'pointer',background: sel?._id===a._id?'#f6f6f6':''}}>
                    {a.username} — <b>{a.platform}</b> — coins: {n(a.coins)}
                  </li>
                ))}
              </ul>
            </div>
            <div>
              <h3>Summary</h3>
              {summary ? <div style={{border:'1px solid #ddd',padding:8}}>
                <div>Coins: <b>{n(summary.coins)}</b></div>
                <div>Total Players: <b>{n(summary.totalPlayers)}</b></div>
                <div>Market Value: <b>{n(summary.totalMarketValue)}</b></div>
                <div>Club Value: <b>{n(summary.clubValue)}</b></div>
              </div> : <div>—</div>}
              <h3 style={{marginTop:12}}>Players</h3>
              <table style={{width:'100%',borderCollapse:'collapse'}}>
                <thead><tr><th style={{textAlign:'left',borderBottom:'1px solid #ddd'}}>Name</th><th style={{borderBottom:'1px solid #ddd'}}>Pos</th><th style={{borderBottom:'1px solid #ddd'}}>Qual</th><th style={{borderBottom:'1px solid #ddd'}}>Rating</th><th style={{borderBottom:'1px solid #ddd'}}>Qty</th><th style={{borderBottom:'1px solid #ddd'}}>Price</th></tr></thead>
                <tbody>
                  {players.map((p,i)=>(
                    <tr key={p.playerId+'-'+i}>
                      <td style={{borderBottom:'1px solid #eee'}}>{p.name}</td>
                      <td style={{borderBottom:'1px solid #eee',textAlign:'center'}}>{p.position}</td>
                      <td style={{borderBottom:'1px solid #eee',textAlign:'center'}}>{p.quality}</td>
                      <td style={{borderBottom:'1px solid #eee',textAlign:'center'}}>{p.rating}</td>
                      <td style={{borderBottom:'1px solid #eee',textAlign:'center'}}>{p.quantity}</td>
                      <td style={{borderBottom:'1px solid #eee',textAlign:'right'}}>{n(p.sellValue)}</td>
                    </tr>
                  ))}
                </tbody>
              </table>
            </div>
          </div>
        </div>);
      }
      JSX
      cd web
      npm install
      npm run build
    startCommand: ""
    staticPublishPath: "web/dist"
